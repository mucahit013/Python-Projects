import json
import socket
import json

class SocketListener:
    def __init__(self,ip,port):
        my_listener=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
        my_listener.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1)  #sock baglantisini surekli tekrarlamak zorunda degiliz.
        my_listener.bind((ip,port))
        my_listener.listen(0)
        print("Listening...")
        (self.my_conection,my_address)=my_listener.accept()   #accept iki baglanti alir. connection ve address diye.
        print("Connection Success from "+str(my_address))


    def json_send(self,data):
        json_data=json.dumps(data)   #as encoding
        self.my_conection.send(json_data)

    def json_receive(self):
        json_data=""
        while True:
            try:
                json_data=json_data + self.my_conection.recv(1024)
                return json.loads(json_data)   #as decoding
            except ValueError:
                continue #dosya boyutlarindan dolayi deger hatasi olursa devam et. okey olana kadar.

    def command_execute(self,command_input):
        self.json_send(command_input) # accept den gelen baglantiyla yolladik.

        if command_input[0]== "quit":
            self.my_conection.close()
            exit()

        return self.json_receive()


    def started_listener(self):
        while True:
            command_input=raw_input("Enter command: ")
            command_input=command_input.split(" ")
            command_output= self.command_execute(command_input)
            print(command_output)

my_listener=SocketListener("10.0.2.10",8080)
my_listener.started_listener()
